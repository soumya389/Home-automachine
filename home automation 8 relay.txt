#include <WiFi.h>
#include <Firebase_ESP_Client.h>


const char* ssid = "soumya";
const char* password = "123456789";


#define API_KEY "AIzaSyACtV2t8SQpMqDNNXc_2Lk4lq70aLdrSus"
#define DATABASE_URL "https://new-html-f8f16-default-rtdb.firebaseio.com/"




FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;


const int relayPins[8] = {2, 4, 5, 18, 19, 21, 22, 23};
bool relayState[8] = {false, false, false, false, false, false, false, false};

void connectToWiFi() {
  Serial.print("Connecting to Wi-Fi");
  WiFi.begin(ssid, password);
  int wifi_retry = 0;
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
    wifi_retry++;
    if (wifi_retry > 30) { 
      Serial.println("\n‚ùå Wi-Fi connection failed!");
      ESP.restart(); 
    }
  }
  Serial.println("\n‚úÖ Wi-Fi connected: " + WiFi.localIP().toString());
}

void connectToFirebase() {
  config.api_key = API_KEY;
  config.database_url = DATABASE_URL;


  auth.user.email = "c.vishnu1500@gmail.com";
  auth.user.password = "vishnu1234";

  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);

  Serial.print("Waiting for Firebase connection");
  int retryCount = 0;
  const int maxRetries = 20;  // 10 seconds max wait
  while (!Firebase.ready() && retryCount < maxRetries) {
    delay(500);
    Serial.print(".");
    retryCount++;
  }

  if (Firebase.ready()) {
    Serial.println("\n‚úÖ Firebase initialized successfully");

   
    Serial.print("üìõ Firebase UID: ");
    Serial.println(auth.token.uid.c_str());
  } else {
    Serial.println("\n‚ùå Firebase initialization timed out");
    ESP.restart(); 
  }
}

void initializeRelays() {
  for (int i = 0; i < 8; i++) {
    pinMode(relayPins[i], OUTPUT);
    digitalWrite(relayPins[i], HIGH); 
  }
  Serial.println("‚úÖ Relays initialized");
}

void checkRelay(int index, const String &path) {
  if (Firebase.RTDB.getBool(&fbdo, path)) {
    bool state = fbdo.boolData();
    if (relayState[index] != state) {
      relayState[index] = state;
      digitalWrite(relayPins[index], state ? LOW : HIGH);
      Serial.println("Relay " + String(index + 1) + " turned " + (state ? "ON" : "OFF"));
    }
  } else {
    Serial.println("‚ùå Failed to read " + path + ": " + fbdo.errorReason());
  }
}

void loopRelays() {
  for (int i = 0; i < 8; i++) {
    checkRelay(i, "/relay" + String(i + 1));
  }
}

void setup() {
  Serial.begin(115200);
  connectToWiFi();
  connectToFirebase();
  initializeRelays();
}

void loop() {
  loopRelays();
  delay(1000); 
}
